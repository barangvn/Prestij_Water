<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Su Arıtma Takip Sistemi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Genel stiller */
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
        }
        .hidden {
            display: none;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }
        input, select, textarea {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, shadow-sm 0.15s ease-in-out;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.15s ease-in-out, transform 0.1s ease-in-out, box-shadow 0.15s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        .btn:hover {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.12);
        }
        .btn-primary {
            background-color: #3b82f6;
            color: #fff;
        }
        .btn-primary:hover {
            background-color: #2563eb;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-danger {
            background-color: #dc2626;
            color: #fff;
        }
        .btn-danger:hover {
            background-color: #b91c1c;
        }
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .table thead tr {
            background-color: #f3f4f6;
            color: #6b7280;
            text-align: left;
        }
        .table th, .table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .table tbody tr:nth-child(odd) {
            background-color: #fff;
        }
        .table tbody tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .table tbody tr:hover {
            background-color: #f0f0f0;
        }
        .text-left { text-align: left; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .font-bold { font-weight: bold; }
        .text-gray-500 { color: #6b7280; }
        .text-blue-600 { color: #2563eb; }
        .text-blue-600:hover { color: #1e40af; }
        .text-red-600 { color: #dc2626; }
        .text-red-600:hover { color: #b91c1c; }
        .mr-2 { margin-right: 0.5rem; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }
        .mt-4 { margin-top: 1rem; }
        .p-4 { padding: 1rem; }
        .rounded { border-radius: 0.375rem; }
        .w-full { width: 100%; }
        .text-sm { font-size: 0.875rem; }
        .font-medium { font-weight: 500; }
        .py-10 { padding-top: 2.5rem; padding-bottom: 2.5rem; }

        /* Ek stiller (örneğin, modal içeriği için) */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #374151;
            margin: 0;
        }
        .modal-body {
            margin-bottom: 1.5rem;
        }
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .select-multiple {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #d1d5db;
            font-size: 1rem;
            transition: border-color 0.15s ease-in-out, shadow-sm 0.15s ease-in-out;
            /* Özel stil: multiple seçime izin ver */
            height: auto;
            min-height: 100px;
            overflow-y: auto;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .select-multiple:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15);
        }
        .select-multiple option {
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            background-color: #eff6ff;
            color: #1f2937;
            font-size: 0.875rem;
            margin-right: 0.25rem;
            cursor: pointer;
        }
        .select-multiple option:hover,
        .select-multiple option:checked {
            background-color: #d1d8f3;
            color: #0369a1;
        }
        .select-multiple option:checked {
            background-color: #3b82f6;
            color: #fff;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
        // Firebase yapılandırma nesnenizi buraya yapıştırın
        const firebaseConfig = {
            apiKey: "AIzaSyAmW3qdlm49cvfVeP27DaAMGJwtKDJ6kyI",
            authDomain: "prestij-water.firebaseapp.com",
            databaseURL: "https://prestij-water-default-rtdb.firebaseio.com",
            projectId: "prestij-water",
            storageBucket: "prestij-water.firebasestorage.app",
            messagingSenderId: "712467125722",
            appId: "1:712467125722:web:e845679e5d456fda2f5ce3",
            measurementId: "G-G0ZYR03RVL"
        };

        // Firebase uygulamasını başlatın
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
    </script>
</head>
<body class="p-4 md:p-8">
    <h1 class="text-2xl font-bold text-gray-800 mb-6">Su Arıtma Takip Sistemi</h1>

    <div class="flex justify-between items-center mb-4">
        <button id="yeni-musteri-goster-btn" class="btn btn-primary">Yeni Müşteri Ekle</button>
        <button id="yeni-urun-goster-btn" class="btn btn-secondary">Yeni Ürün Ekle</button>
    </div>

    <div id="musteri-formu" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="modal-header">Yeni Müşteri Ekle</h2>
            <form id="musteri-form" class="modal-body">
                <div class="form-group">
                    <label for="musteri-ad">Ad Soyad:</label>
                    <input type="text" id="musteri-ad" required>
                </div>
                <div class="form-group">
                    <label for="musteri-tel">Telefon:</label>
                    <input type="tel" id="musteri-tel" required>
                </div>
                <div class="form-group">
                    <label for="musteri-adres">Adres:</label>
                    <textarea id="musteri-adres" required></textarea>
                </div>
                <div class="form-group">
                    <label for="musteri-cihaz">Cihaz:</label>
                    <input type="text" id="musteri-cihaz" required>
                </div>
                <div class="form-group">
                    <label for="musteri-teknisyen">Teknisyen:</label>
                    <input type="text" id="musteri-teknisyen" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary close-button">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="stok-formu" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="modal-header">Yeni Ürün Ekle</h2>
            <form id="stok-form" class="modal-body">
                <div class="form-group">
                    <label for="urun-ad">Ürün Adı:</label>
                    <input type="text" id="urun-ad" required>
                </div>
                <div class="form-group">
                    <label for="stok-miktar">Miktar:</label>
                    <input type="number" id="stok-miktar" value="0" required>
                </div>
                <div class="form-group">
                    <label for="min-stok">Minimum Stok:</label>
                    <input type="number" id="min-stok" value="0" required>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary close-button">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div id="musteriDetayModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="modal-header">Müşteri Detayları</h2>
            <div class="modal-body">
                <p><span class="font-bold">Ad Soyad:</span> <span id="modal-musteri-ad"></span></p>
                <p><span class="font-bold">Telefon:</span> <span id="modal-musteri-tel"></span></p>
                <p><span class="font-bold">Cihaz:</span> <span id="modal-musteri-cihaz"></span></p>
                <p><span class="font-bold">Adres:</span> <span id="modal-musteri-adres"></span></p>
                <p><span class="font-bold">Teknisyen:</span> <span id="modal-musteri-teknisyen"></span></p>

                <h3 class="mt-4 text-lg font-semibold">Servis Geçmişi</h3>
                <table id="modal-servis-listesi" class="table">
                    <thead>
                        <tr>
                            <th class="px-3 py-2">Tarih</th>
                            <th class="px-3 py-2">İşlem Türü</th>
                            <th class="px-3 py-2">Kullanılan Ürünler</th>
                            <th class="px-3 py-2">Teknisyen</th>
                            <th class="px-3 py-2">Sonraki Bakım</th>
                            <th class="px-3 py-2">Erteleme Notu</th>
                            <th class="px-3 py-2">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="7" class="text-center py-10 text-gray-500">Servis kayıtları yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>

                <h3 class="mt-4 text-lg font-semibold">Yeni Servis Kaydı Ekle</h3>
                <form id="servis-kaydi-form" class="mt-4">
                    <div class="form-group">
                        <label for="servis-tarih">Tarih:</label>
                        <input type="date" id="servis-tarih" required>
                    </div>
                    <div class="form-group">
                        <label for="servis-islem-turu">İşlem Türü:</label>
                        <input type="text" id="servis-islem-turu" required>
                    </div>
                    <div class="form-group">
                        <label for="servis-kullanilan-urunler">Kullanılan Ürünler:</label>
                        <select id="servis-kullanilan-urunler" multiple required class="select-multiple">
                            </select>
                    </div>
                    <div class="form-group">
                        <label for="servis-teknisyen">Teknisyen:</label>
                        <input type="text" id="servis-teknisyen" >
                    </div>
                    <div class="form-group">
                        <label for="servis-ek-notlar">Ek Notlar:</label>
                        <textarea id="servis-ek-notlar"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="servis-sonraki-bakim">Sonraki Bakım (Ay):</label>
                        <input type="number" id="servis-sonraki-bakim" value="0">
                    </div>
                    <div class="form-group">
                        <label for="servis-erteleme-notu">Erteleme Notu:</label>
                        <input type="text" id="servis-erteleme-notu">
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                        <button type="button" class="btn btn-secondary close-button">İptal</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="servisDuzenleModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 class="modal-header">Servis Kaydı Düzenle</h2>
            <form id="servis-duzenle-form" class="modal-body">
                <input type="hidden" id="edit-kayit-id">
                <div class="form-group">
                    <label for="edit-servis-tarih">Tarih:</label>
                    <input type="date" id="edit-servis-tarih" required>
                </div>
                <div class="form-group">
                    <label for="edit-servis-islem-turu">İşlem Türü:</label>
                    <input type="text" id="edit-servis-islem-turu" required>
                </div>
                <div class="form-group">
                    <label for="edit-servis-kullanilan-urunler">Kullanılan Ürünler:</label>
                    <select id="edit-servis-kullanilan-urunler" multiple required class="select-multiple">
                        </select>
                </div>
                <div class="form-group">
                    <label for="edit-servis-teknisyen">Teknisyen:</label>
                    <input type="text" id="edit-servis-teknisyen">
                </div>
                <div class="form-group">
                    <label for="edit-servis-ek-notlar">Ek Notlar:</label>
                    <textarea id="edit-servis-ek-notlar"></textarea>
                </div>
                <div class="form-group">
                    <label for="edit-servis-sonraki-bakim">Sonraki Bakım (Ay):</label>
                    <input type="number" id="edit-servis-sonraki-bakim" value="0">
                </div>
                <div class="form-group">
                    <label for="edit-servis-erteleme-notu">Erteleme Notu:</label>
                    <input type="text" id="edit-servis-erteleme-notu">
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                    <button type="button" class="btn btn-secondary close-button">İptal</button>
                </div>
            </form>
        </div>
    </div>

    <div class="table-container">
        <div class="flex">
            <div style="flex: 1; margin-right: 1rem;">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Müşteri Listesi</h2>
                <table id="musteri-listesi" class="table">
                    <thead>
                        <tr>
                            <th class="px-3 py-2">Ad Soyad</th>
                            <th class="px-3 py-2">Telefon</th>
                            <th class="px-3 py-2">Cihaz</th>
                            <th class="px-3 py-2">Adres</th>
                            <th class="px-3 py-2">Teknisyen</th>
                            <th class="px-3 py-2">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" class="text-center py-10 text-gray-500">Müşteri verileri yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div style="flex: 1;">
                <h2 class="text-xl font-semibold text-gray-800 mb-3">Stok Listesi</h2>
                <table id="stok-listesi" class="table">
                    <thead>
                        <tr>
                            <th class="px-3 py-2">Ürün Adı</th>
                            <th class="px-3 py-2">Miktar</th>
                            <th class="px-3 py-2">Minimum Stok</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="3" class="text-center py-10 text-gray-500">Stok verileri yükleniyor...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Modal elementlerini seç
        const musteriFormu = document.getElementById('musteri-formu');
        const stokFormu = document.getElementById('stok-formu');
        const musteriDetayModal = document.getElementById('musteriDetayModal');
        const servisDuzenleModal = document.getElementById('servisDuzenleModal');

        // Buton elementlerini seç
        const yeniMusteriGosterBtn = document.getElementById('yeni-musteri-goster-btn');
        const yeniUrunGosterBtn = document.getElementById('yeni-urun-goster-btn');
        const musteriForm = document.getElementById('musteri-form');
        const stokForm = document.getElementById('stok-form');
        const modalCloseButtons = document.querySelectorAll('.close-button');
        const servisKaydiForm = document.getElementById('servis-kaydi-form');
        const servisDuzenleForm = document.getElementById('servis-duzenle-form');

        // Tablo elementlerini seç
        const musteriListesi = document.getElementById('musteri-listesi').querySelector('tbody');
        const stokListesi = document.getElementById('stok-listesi').querySelector('tbody');
        const modalServisListesi = document.getElementById('modal-servis-listesi');

        // Select elementlerini seç
        const servisKullanilanUrunlerSelect = document.getElementById('servis-kullanilan-urunler');
        const editServisKullanilanUrunlerSelect = document.getElementById('edit-servis-kullanilan-urunler');

        let musteriler = [];
        let stoklar = [];
        let mevcutMusteriIndex = null;
        let originalServiceRecordProducts = []; // Keep track of original products in service record


        // Modal açma fonksiyonları
        yeniMusteriGosterBtn.addEventListener('click', () => {
            musteriFormu.classList.remove('hidden');
            yeniMusteriGosterBtn.classList.add('hidden');
        });

        yeniUrunGosterBtn.addEventListener('click', () => {
            stokFormu.classList.remove('hidden');
            yeniUrunGosterBtn.classList.add('hidden');
        });

        // Modal kapatma fonksiyonu
        modalCloseButtons.forEach(button => {
            button.addEventListener('click', () => {
                const modal = button.closest('.modal');
                if(modal) {
                    modal.classList.add('hidden');
                }
                if (modal.id === 'musteriFormu') {
                    yeniMusteriGosterBtn.classList.remove('hidden');
                } else if (modal.id === 'stokFormu') {
                    yeniUrunGosterBtn.classList.remove('hidden');
                }
            });
        });

        // Müşteri Ekleme Formu Gönderildiğinde
        musteriForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const ad = document.getElementById('musteri-ad').value;
            const tel = document.getElementById('musteri-tel').value;
            const adres = document.getElementById('musteri-adres').value;
            const cihaz = document.getElementById('musteri-cihaz').value;
            const teknisyen = document.getElementById('musteri-teknisyen').value;
            const id = Date.now(); // Basit bir ID oluşturma

            const yeniMusteri = { id, ad, tel, adres, cihaz, teknisyen, servisKayitlari: [] };

            database.ref(`/musteriler/${id}`).set(yeniMusteri)
                .then(() => {
                    musteriForm.reset();
                    musteriFormu.classList.add('hidden');
                    yeniMusteriGosterBtn.classList.remove('hidden');
                    // Veriler 'value' event'ı ile otomatik olarak güncelleneceği için
                    // manuel olarak musterileriGoster() çağırmanıza gerek kalmayabilir.
                })
                .catch((error) => {
                    console.error("Müşteri eklenirken hata:", error);
                    alert("Müşteri eklenirken bir hata oluştu.");
                });
        });

        // Ürün Ekleme Formu Gönderildiğinde
        stokForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const ad = document.getElementById('urun-ad').value;
            const miktar = parseInt(document.getElementById('stok-miktar').value);
            const minStok = parseInt(document.getElementById('min-stok').value);
            const id = Date.now();

            const yeniUrun = { id, ad, miktar, minStok };

            database.ref(`/stoklar/${id}`).set(yeniUrun)
                .then(() => {
                    stokForm.reset();
                    stokFormu.classList.add('hidden');
                    yeniUrunGosterBtn.classList.remove('hidden');
                })
                .catch((error) => {
                    console.error("Ürün eklenirken hata:", error);
                    alert("Ürün eklenirken bir hata oluştu.");
                });
        });

        function musteriSil() {
            if (mevcutMusteriIndex !== null && confirm('Müşteriyi silmek istediğinize emin misiniz?')) {
                const silinecekMusteriId = musteriler[mevcutMusteriIndex].id;
                database.ref(`/musteriler/${silinecekMusteriId}`).remove()
                    .then(() => {
                        kapatModal('musteriDetayModal');
                        mevcutMusteriIndex = null;
                        // Veriler 'value' event'ı ile otomatik olarak güncellenecek.
                    })
                    .catch((error) => {
                        console.error("Müşteri silinirken hata:", error);
                        alert("Müşteri silinirken bir hata oluştu.");
                    });
            }
        }

        function servisKaydiSil(kayitId) {
            if (mevcutMusteriIndex !== null && confirm('Servis kaydını silmek istediğinize emin misiniz?')) {
                const musteriId = musteriler[mevcutMusteriIndex].id;
                database.ref(`/musteriler/${musteriId}/servisKayitlari/${kayitId}`).remove()
                    .then(() => {
                        // Servis geçmişi 'value' event'ı ile otomatik olarak güncellenecek.
                    })
                    .catch((error) => {
                        console.error("Servis kaydı silinirken hata:", error);
                        alert("Servis kaydı silinirken bir hata oluştu.");
                    });
            }
        }

        function musteriDetayGoster(index) {
            mevcutMusteriIndex = index;
            const musteri = musteriler[index];
            document.getElementById('modal-musteri-ad').textContent = musteri.ad;
            document.getElementById('modal-musteri-tel').textContent = musteri.tel;
            document.getElementById('modal-musteri-cihaz').textContent = musteri.cihaz;
            document.getElementById('modal-musteri-adres').textContent = musteri.adres;
            document.getElementById('modal-musteri-teknisyen').textContent = musteri.teknisyen;

            // Servis geçmişini temizle
            modalServisListesi.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-gray-500">Servis kayıtları yükleniyor...</td></tr>';

            // İlgili müşterinin servis kayıtlarını Firebase'den çek
            database.ref(`/musteriler/${musteri.id}/servisKayitlari`).on('value', (snapshot) => {
                const servisKayitlariData = snapshot.val();
                const servisKayitlari = servisKayitlariData ? Object.values(servisKayitlariData) : [];

                if (servisKayitlari.length === 0) {
                    modalServisListesi.innerHTML = '<tr><td colspan="7" class="text-center py-10 text-gray-500">Bu müşteri için servis kaydı bulunmamaktadır.</td></tr>';
                    return;
                }

                modalServisListesi.innerHTML = ''; // Önceki içeriği temizle

                servisKayitlari.forEach(kayit => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.tarih}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.tur}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.urunler.join(', ')}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.teknisyen}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.sonrakiBakimAy ? `${kayit.sonrakiBakimAy} Ay Sonra` : 'Yok'}</td>
                        <td class="px-3 py-2 text-sm text-gray-500">${kayit.ertelemeNotu || '-'}</td>
                        <td class="px-3 py-2 text-sm font-medium">
                            <button onclick="servisKaydiDuzenle('${musteri.id}', '${kayit.id}')" class="text-blue-600 hover:text-blue-900 mr-2">Düzenle</button>
                            <button onclick="servisKaydiSil('${kayit.id}')" class="text-red-600 hover:text-red-900">Sil</button>
                        </td>
                    `;
                    modalServisListesi.appendChild(tr);
                });

                // Eğer servis düzenle modalında ürünleri göstermeniz gerekiyorsa burada doldurun
                stokUrunleriniDoldur(editServisKullanilanUrunlerSelect);
            });

            // Modalı göster
            musteriDetayModal.style.display = 'block';
        }

        function servisKaydiDuzenle(musteriId, kayitId) {
            // Önceki seçilen ürünleri temizle
            editServisKullanilanUrunlerSelect.innerHTML = '';
            originalServiceRecordProducts = [];

            database.ref(`/musteriler/${musteriId}/servisKayitlari/${kayitId}`).once('value', (snapshot) => {
                const kayit = snapshot.val();
                if (!kayit) return;

                document.getElementById('edit-kayit-id').value = kayitId;
                document.getElementById('edit-servis-tarih').value = kayit.tarih;
                document.getElementById('edit-servis-islem-turu').value = kayit.tur;
                document.getElementById('edit-servis-teknisyen').value = kayit.teknisyen;
                document.getElementById('edit-servis-ek-notlar').value = kayit.notlar;
                document.getElementById('edit-servis-sonraki-bakim').value = kayit.sonrakiBakimAy || 0;
                document.getElementById('edit-servis-erteleme-notu').value = kayit.ertelemeNotu || '';

                // Ürünleri selectbox'a doldur ve seçili olanları işaretle
                stokUrunleriniDoldur(editServisKullanilanUrunlerSelect, kayit.urunler);
                originalServiceRecordProducts = [...kayit.urunler]; // Keep original product list

                servisDuzenleModal.style.display = 'block';
            });
        }

        servisDuzenleForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const musteriId = musteriler[mevcutMusteriIndex].id;
            const kayitId = document.getElementById('edit-kayit-id').value;
            const servisTarih = document.getElementById('edit-servis-tarih').value;
            const servisIslemTuru = document.getElementById('edit-servis-islem-turu').value;
            const servisTeknisyen = document.getElementById('edit-servis-teknisyen').value;
            const kullanilanUrunler = Array.from(editServisKullanilanUrunlerSelect.selectedOptions).map(option => option.value);
            const servisEkNotlar = document.getElementById('edit-servis-ek-notlar').value;
            const sonrakiBakimAy = parseInt(document.getElementById('edit-servis-sonraki-bakim').value);
            const servisErtelemeNotu = document.getElementById('edit-servis-erteleme-notu').value;

            const guncellenenServisKaydi = {
                tarih: servisTarih,
                tur: servisIslemTuru,
                urunler: kullanilanUrunler,
                teknisyen: servisTeknisyen,
                notlar: servisEkNotlar,
                sonrakiBakimAy: sonrakiBakimAy,
                ertelemeNotu: servisErtelemeNotu
            };

            database.ref(`/musteriler/${musteriId}/servisKayitlari/${kayitId}`).update(guncellenenServisKaydi)
                .then(() => {
                    kapatModal('servisDuzenleModal');
                    // Servis geçmişi 'value' event'ı ile otomatik olarak güncellenecek.

                    // Stok güncelleme mantığını da burada yönetmeniz gerekebilir.
                    // Özellikle düzenleme sırasında eklenen/çıkarılan ürünlerin stoklarını güncelleme.
                    // Bu kısım uygulamanızın gereksinimlerine göre daha karmaşık olabilir.
                    updateStocksForServiceRecord(musteriId, kayitId, kullanilanUrunler);
                })
                .catch((error) => {
                    console.error("Servis kaydı düzenlenirken hata:", error);
                    alert("Servis kaydı düzenlenirken bir hata oluştu.");
                });
        });

        function updateStocksForServiceRecord(musteriId, kayitId, kullanilanUrunler) {
            // 1. Get the original service record's products
            database.ref(`/musteriler/${musteriId}/servisKayitlari/${kayitId}`).once('value', (snapshot) => {
                const originalRecord = snapshot.val();
                if (!originalRecord) return;

                const originalProducts = originalRecord.urunler || [];

                // 2. Calculate products added and removed
                const removedProducts = originalProducts.filter(id => !kullanilanUrunler.includes(id));
                const addedProducts = kullanilanUrunler.filter(id => !originalProducts.includes(id));

                // 3. Update stock for removed products (increase stock)
                removedProducts.forEach(productId => {
                    database.ref(`/stoklar/${productId}/miktar`).once('value', (snapshot) => {
                        const currentStock = snapshot.val() || 0;
                        database.ref(`/stoklar/${productId}`).update({ miktar: currentStock + 1 });
                    });
                });

                // 4. Update stock for added products (decrease stock)
                addedProducts.forEach(productId => {
                    database.ref(`/stoklar/${productId}/miktar`).once('value', (snapshot) => {
                        const currentStock = snapshot.val() || 0;
                        if (currentStock > 0) { // prevent negative stock
                            database.ref(`/stoklar/${productId}`).update({ miktar: currentStock - 1 });
                        }
                    });
                });
            });
        }

        function stokUrunleriniDoldur(selectElement, selectedValues = []) {
            selectElement.innerHTML = ''; // Önceki seçenekleri temizle

            stoklar.forEach(urun => {
                const option = document.createElement('option');
                option.value = urun.id;
                option.textContent = `${urun.ad} (${urun.miktar} adet)`;
                if (selectedValues.includes(urun.id)) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Firebase'den müşteri verilerini oku
            database.ref('/musteriler').on('value', (snapshot) => {
                const data = snapshot.val();
                musteriler = data ? Object.values(data) : [];
                musterileriGoster();
            });

            // Firebase'den stok verilerini oku
            database.ref('/stoklar').on('value', (snapshot) => {
                const data = snapshot.val();
                stoklar = data ? Object.values(data) : [];
                stoklariGoster();
                stokUrunleriniDoldur(servisKullanilanUrunlerSelect);
                stokUrunleriniDoldur(editServisKullanilanUrunlerSelect);
            });

             servisKaydiForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (mevcutMusteriIndex === null) return;

                const musteriId = musteriler[mevcutMusteriIndex].id;
                const servisTarih = document.getElementById('servis-tarih').value;
                const servisIslemTuru = document.getElementById('servis-islem-turu').value;
                const servisTeknisyen = document.getElementById('servis-teknisyen').value || musteriler[mevcutMusteriIndex].teknisyen;
                const kullanilanUrunler = Array.from(servisKullanilanUrunlerSelect.selectedOptions).map(option => option.value);
                const servisEkNotlar = document.getElementById('servis-ek-notlar').value;
                const sonrakiBakimAy = parseInt(document.getElementById('servis-sonraki-bakim').value);
                const servisErtelemeNotu = document.getElementById('servis-erteleme-notu').value;
                const servisKayitId = Date.now();

                const yeniServisKaydi = {
                    id: servisKayitId,
                    tarih: servisTarih,
                    tur: servisIslemTuru,
                    urunler: kullanilanUrunler,
                    teknisyen: servisTeknisyen,
                    notlar: servisEkNotlar,
                    sonrakiBakimAy: sonrakiBakimAy,
                    ertelemeNotu: servisErtelemeNotu
                };

                database.ref(`/musteriler/${musteriId}/servisKayitlari/${servisKayitId}`).set(yeniServisKaydi)
                    .then(() => {
                        servisKaydiForm.reset();
                        kapatModal('musteriDetayModal');
                        // Servis geçmişi 'value' event'ı ile otomatik olarak güncellenecek.
                         updateStocksForServiceRecord(musteriId, servisKayitId, kullanilanUrunler);
                    })
                    .catch((error) => {
                        console.error("Servis kaydı eklenirken hata:", error);
                        alert("Servis kaydı eklenirken bir hata oluştu.");
                    });

                // Stok güncelleme işlemlerini de burada yapmanız gerekecek.
                // Kullanılan ürünlerin miktarını stoklardan düşürme.
               /* kullanilanUrunler.forEach(urunId => {
                    const urunRef = database.ref(`/stoklar/${urunId}`);
                    urunRef.once('value', (snapshot) => {
                        const urun = snapshot.val();
                        if (urun && urun.miktar > 0) {
                            urunRef.update({ miktar: urun.miktar - 1 });
                        }
                    });
                });*/
            });
        });
    });

    function kapatModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    function musterileriGoster() {
        musteriListesi.innerHTML = ''; // Önceki içeriği temizle
        musteriler.forEach((musteri, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-3 py-2 text-gray-500">${musteri.ad}</td>
                <td class="px-3 py-2 text-gray-500">${musteri.tel}</td>
                <td class="px-3 py-2 text-gray-500">${musteri.cihaz}</td>
                <td class="px-3 py-2 text-gray-500">${musteri.adres}</td>
                <td class="px-3 py-2 text-gray-500">${musteri.teknisyen}</td>
                <td class="px-3 py-2 text-sm font-medium">
                    <button onclick="musteriDetayGoster(${index})" class="text-blue-600 hover:text-blue-900 mr-2">Detaylar</button>
                    <button onclick="musteriSil()" class="text-red-600 hover:text-red-900">Sil</button>
                </td>
            `;
            musteriListesi.appendChild(tr);
        });
    }

    function stoklariGoster() {
        stokListesi.innerHTML = ''; // Önceki içeriği temizle
        stoklar.forEach(urun => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="px-3 py-2 text-gray-500">${urun.ad}</td>
                <td class="px-3 py-2 text-gray-500">${urun.miktar}</td>
                <td class="px-3 py-2 text-gray-500">${urun.minStok}</td>
            `;
            stokListesi.appendChild(tr);
        });
    }
    </script>
</body>
</html>
